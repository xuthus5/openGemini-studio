# Copyright 2026 openGemini Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


name: Wails build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  # Necessary for most environments as build failure can occur due to OOM issues
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build:
    strategy:
      # Failure in one platform build won't impact the others
      fail-fast: false
      matrix:
        build:
          - name: 'openGemini-studio'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
          - name: 'openGemini-studio'
            platform: 'windows/amd64'
            os: 'windows-latest'
          - name: 'openGemini-studio'
            platform: 'darwin/universal'
            os: 'macos-latest'

    runs-on: ${{ matrix.build.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Application
        run: wails build -platform ${{ matrix.build.platform }} -tags webkit2_41 -clean

      - name: Prepare artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          cd build/bin
          tar -czf openGemini-studio-linux-amd64.tar.gz openGemini-studio

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd build/bin
          Compress-Archive -Path openGemini-studio.exe -DestinationPath openGemini-studio-windows-amd64.zip

      - name: Prepare artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          cd build/bin
          tar -czf openGemini-studio-darwin-universal.tar.gz openGemini-studio.app

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.name }}-${{ runner.os }}-${{ runner.arch }}
          path: |
            build/bin/*.tar.gz
            build/bin/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Collect all release files
        run: |
          mkdir -p release-files
          find artifacts -name "*.tar.gz" -exec cp {} release-files/ \;
          find artifacts -name "*.zip" -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Determine release info
        id: release_info
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag release
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "release_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "is_nightly=false" >> $GITHUB_OUTPUT
          else
            # Nightly release from main branch
            echo "tag_name=nightly" >> $GITHUB_OUTPUT
            echo "release_name=Nightly Build" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "is_nightly=true" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing nightly release
        if: steps.release_info.outputs.is_nightly == 'true'
        run: |
          # Delete the release if it exists
          gh release delete nightly --yes --cleanup-tag || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get existing release body (for tag releases)
        if: steps.release_info.outputs.is_nightly == 'false'
        id: existing_release
        run: |
          # Try to get existing release body
          EXISTING_BODY=$(gh release view ${{ steps.release_info.outputs.tag_name }} --json body -q .body 2>/dev/null || echo "")
          if [ -n "$EXISTING_BODY" ]; then
            echo "has_existing=true" >> $GITHUB_OUTPUT
            echo "$EXISTING_BODY" > existing_body.md
          else
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release body
        id: release_body
        run: |
          if [[ "${{ steps.release_info.outputs.is_nightly }}" == "true" ]]; then
            cat << 'EOF' > release_body.md
          ðŸŒ™ **Nightly Build**

          This is an automated nightly build from the main branch.

          **Build Information:**
          - Commit: ${{ github.sha }}
          - Build Date: ${{ github.event.head_commit.timestamp }}
          - Commit Message: ${{ github.event.head_commit.message }}
          - Branch: main

          ## ðŸ“¦ Downloads
          - **Linux**: openGemini-studio-linux-amd64.tar.gz
          - **Windows**: openGemini-studio-windows-amd64.zip
          - **macOS**: openGemini-studio-darwin-universal.tar.gz

          ## ðŸ“– Installation

          ### Linux
          ```bash
          tar -xzf openGemini-studio-linux-amd64.tar.gz
          chmod +x openGemini-studio
          ./openGemini-studio
          ```

          ### Windows
          Extract the zip file and run `openGemini-studio.exe`

          ### macOS
          ```bash
          tar -xzf openGemini-studio-darwin-universal.tar.gz
          open openGemini-studio.app
          ```

          âš ï¸ **Note**: This is a nightly build and may contain unstable features or bugs.
          EOF
          else
            # For tag releases, append build info to existing body
            if [[ "${{ steps.existing_release.outputs.has_existing }}" == "true" ]]; then
              # Append to existing body
              cat existing_body.md > release_body.md
              echo "" >> release_body.md
              echo "---" >> release_body.md
              echo "" >> release_body.md
            fi

            # Add build information
            cat << 'EOF' >> release_body.md
          ## ðŸ“¦ Downloads (Build ${{ github.sha }})

          **Build Information:**
          - Commit: ${{ github.sha }}
          - Build Date: ${{ github.event.head_commit.timestamp }}

          ### Available Downloads
          - **Linux**: openGemini-studio-linux-amd64.tar.gz
          - **Windows**: openGemini-studio-windows-amd64.zip
          - **macOS**: openGemini-studio-darwin-universal.tar.gz

          ## ðŸ“– Installation

          ### Linux
          ```bash
          tar -xzf openGemini-studio-linux-amd64.tar.gz
          chmod +x openGemini-studio
          ./openGemini-studio
          ```

          ### Windows
          Extract the zip file and run `openGemini-studio.exe`

          ### macOS
          ```bash
          tar -xzf openGemini-studio-darwin-universal.tar.gz
          open openGemini-studio.app
          ```
          EOF
          fi

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          body_path: release_body.md
          files: release-files/*
          prerelease: ${{ steps.release_info.outputs.prerelease }}
          draft: false
